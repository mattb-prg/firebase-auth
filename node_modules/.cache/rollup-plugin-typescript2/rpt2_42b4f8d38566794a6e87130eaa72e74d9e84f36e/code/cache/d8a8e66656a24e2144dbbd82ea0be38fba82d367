{"code":"/**\r\n * @license\r\n * Copyright 2020 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nimport { __awaiter, __generator } from \"tslib\";\r\nimport { AuthEventManager } from '../core/auth/auth_event_manager';\r\nimport { _assert, debugAssert, _fail } from '../core/util/assert';\r\nimport { _generateEventId } from '../core/util/event_id';\r\nimport { _getCurrentUrl } from '../core/util/location';\r\nimport { _validateOrigin } from '../core/util/validate_origin';\r\nimport { _setWindowLocation } from './auth_window';\r\nimport { _openIframe } from './iframe/iframe';\r\nimport { browserSessionPersistence } from './persistence/session_storage';\r\nimport { _open } from './util/popup';\r\nimport { _getRedirectResult } from './strategies/redirect';\r\nimport { _getRedirectUrl } from '../core/util/handler';\r\nimport { _isIOS, _isMobileBrowser, _isSafari } from '../core/util/browser';\r\nimport { _overrideRedirectResult } from '../core/strategies/redirect';\r\n/**\r\n * The special web storage event\r\n *\r\n */\r\nvar WEB_STORAGE_SUPPORT_KEY = 'webStorageSupport';\r\nvar BrowserPopupRedirectResolver = /** @class */ (function () {\r\n    function BrowserPopupRedirectResolver() {\r\n        this.eventManagers = {};\r\n        this.iframes = {};\r\n        this.originValidationPromises = {};\r\n        this._redirectPersistence = browserSessionPersistence;\r\n        this._completeRedirectFn = _getRedirectResult;\r\n        this._overrideRedirectResult = _overrideRedirectResult;\r\n    }\r\n    // Wrapping in async even though we don't await anywhere in order\r\n    // to make sure errors are raised as promise rejections\r\n    BrowserPopupRedirectResolver.prototype._openPopup = function (auth, provider, authType, eventId) {\r\n        var _a;\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var url;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        debugAssert((_a = this.eventManagers[auth._key()]) === null || _a === void 0 ? void 0 : _a.manager, '_initialize() not called before _openPopup()');\r\n                        return [4 /*yield*/, _getRedirectUrl(auth, provider, authType, _getCurrentUrl(), eventId)];\r\n                    case 1:\r\n                        url = _b.sent();\r\n                        return [2 /*return*/, _open(auth, url, _generateEventId())];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    BrowserPopupRedirectResolver.prototype._openRedirect = function (auth, provider, authType, eventId) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var url;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this._originValidation(auth)];\r\n                    case 1:\r\n                        _a.sent();\r\n                        return [4 /*yield*/, _getRedirectUrl(auth, provider, authType, _getCurrentUrl(), eventId)];\r\n                    case 2:\r\n                        url = _a.sent();\r\n                        _setWindowLocation(url);\r\n                        return [2 /*return*/, new Promise(function () { })];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    BrowserPopupRedirectResolver.prototype._initialize = function (auth) {\r\n        var _this = this;\r\n        var key = auth._key();\r\n        if (this.eventManagers[key]) {\r\n            var _a = this.eventManagers[key], manager = _a.manager, promise_1 = _a.promise;\r\n            if (manager) {\r\n                return Promise.resolve(manager);\r\n            }\r\n            else {\r\n                debugAssert(promise_1, 'If manager is not set, promise should be');\r\n                return promise_1;\r\n            }\r\n        }\r\n        var promise = this.initAndGetManager(auth);\r\n        this.eventManagers[key] = { promise: promise };\r\n        // If the promise is rejected, the key should be removed so that the\r\n        // operation can be retried later.\r\n        promise.catch(function () {\r\n            delete _this.eventManagers[key];\r\n        });\r\n        return promise;\r\n    };\r\n    BrowserPopupRedirectResolver.prototype.initAndGetManager = function (auth) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var iframe, manager;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, _openIframe(auth)];\r\n                    case 1:\r\n                        iframe = _a.sent();\r\n                        manager = new AuthEventManager(auth);\r\n                        iframe.register('authEvent', function (iframeEvent) {\r\n                            _assert(iframeEvent === null || iframeEvent === void 0 ? void 0 : iframeEvent.authEvent, auth, \"invalid-auth-event\" /* AuthErrorCode.INVALID_AUTH_EVENT */);\r\n                            // TODO: Consider splitting redirect and popup events earlier on\r\n                            var handled = manager.onEvent(iframeEvent.authEvent);\r\n                            return { status: handled ? \"ACK\" /* GapiOutcome.ACK */ : \"ERROR\" /* GapiOutcome.ERROR */ };\r\n                        }, gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER);\r\n                        this.eventManagers[auth._key()] = { manager: manager };\r\n                        this.iframes[auth._key()] = iframe;\r\n                        return [2 /*return*/, manager];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    BrowserPopupRedirectResolver.prototype._isIframeWebStorageSupported = function (auth, cb) {\r\n        var iframe = this.iframes[auth._key()];\r\n        iframe.send(WEB_STORAGE_SUPPORT_KEY, { type: WEB_STORAGE_SUPPORT_KEY }, function (result) {\r\n            var _a;\r\n            var isSupported = (_a = result === null || result === void 0 ? void 0 : result[0]) === null || _a === void 0 ? void 0 : _a[WEB_STORAGE_SUPPORT_KEY];\r\n            if (isSupported !== undefined) {\r\n                cb(!!isSupported);\r\n            }\r\n            _fail(auth, \"internal-error\" /* AuthErrorCode.INTERNAL_ERROR */);\r\n        }, gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER);\r\n    };\r\n    BrowserPopupRedirectResolver.prototype._originValidation = function (auth) {\r\n        var key = auth._key();\r\n        if (!this.originValidationPromises[key]) {\r\n            this.originValidationPromises[key] = _validateOrigin(auth);\r\n        }\r\n        return this.originValidationPromises[key];\r\n    };\r\n    Object.defineProperty(BrowserPopupRedirectResolver.prototype, \"_shouldInitProactively\", {\r\n        get: function () {\r\n            // Mobile browsers and Safari need to optimistically initialize\r\n            return _isMobileBrowser() || _isSafari() || _isIOS();\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    return BrowserPopupRedirectResolver;\r\n}());\r\n/**\r\n * An implementation of {@link PopupRedirectResolver} suitable for browser\r\n * based applications.\r\n *\r\n * @remarks\r\n * This method does not work in a Node.js environment.\r\n *\r\n * @public\r\n */\r\nexport var browserPopupRedirectResolver = BrowserPopupRedirectResolver;\r\n//# sourceMappingURL=popup_redirect.js.map","references":["/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/model/public_types.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/auth/auth_event_manager.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/errors.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/util/assert.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/util/event_id.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/util/location.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/util/validate_origin.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/model/auth.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/model/popup_redirect.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_browser/auth_window.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_browser/iframe/iframe.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_browser/persistence/session_storage.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_browser/util/popup.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_browser/strategies/redirect.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/util/handler.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/util/browser.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/strategies/redirect.ts"],"map":"{\"version\":3,\"file\":\"popup_redirect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../src/platform_browser/popup_redirect.ts\"],\"names\":[],\"mappings\":\"AAAA;;;;;;;;;;;;;;;GAeG;;AAIH,OAAO,EAAE,gBAAgB,EAAE,MAAM,iCAAiC,CAAC;AAEnE,OAAO,EAAE,OAAO,EAAE,WAAW,EAAE,KAAK,EAAE,MAAM,qBAAqB,CAAC;AAClE,OAAO,EAAE,gBAAgB,EAAE,MAAM,uBAAuB,CAAC;AACzD,OAAO,EAAE,cAAc,EAAE,MAAM,uBAAuB,CAAC;AACvD,OAAO,EAAE,eAAe,EAAE,MAAM,8BAA8B,CAAC;AAS/D,OAAO,EAAE,kBAAkB,EAAE,MAAM,eAAe,CAAC;AACnD,OAAO,EAAE,WAAW,EAAE,MAAM,iBAAiB,CAAC;AAC9C,OAAO,EAAE,yBAAyB,EAAE,MAAM,+BAA+B,CAAC;AAC1E,OAAO,EAAE,KAAK,EAAa,MAAM,cAAc,CAAC;AAChD,OAAO,EAAE,kBAAkB,EAAE,MAAM,uBAAuB,CAAC;AAC3D,OAAO,EAAE,eAAe,EAAE,MAAM,sBAAsB,CAAC;AACvD,OAAO,EAAE,MAAM,EAAE,gBAAgB,EAAE,SAAS,EAAE,MAAM,sBAAsB,CAAC;AAC3E,OAAO,EAAE,uBAAuB,EAAE,MAAM,6BAA6B,CAAC;AAEtE;;;GAGG;AACH,IAAM,uBAAuB,GAAG,mBAAmB,CAAC;AAWpD;IAAA;QACmB,kBAAa,GAAqC,EAAE,CAAC;QACrD,YAAO,GAAwC,EAAE,CAAC;QAClD,6BAAwB,GAAkC,EAAE,CAAC;QAErE,yBAAoB,GAAG,yBAAyB,CAAC;QAyH1D,wBAAmB,GAAG,kBAAkB,CAAC;QAEzC,4BAAuB,GAAG,uBAAuB,CAAC;IACpD,CAAC;IA1HC,iEAAiE;IACjE,uDAAuD;IACjD,iDAAU,GAAhB,UACE,IAAkB,EAClB,QAAsB,EACtB,QAAuB,EACvB,OAAgB;;;;;;;wBAEhB,WAAW,CACT,MAAA,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC,0CAAE,OAAO,EACxC,8CAA8C,CAC/C,CAAC;wBAEU,qBAAM,eAAe,CAC/B,IAAI,EACJ,QAAQ,EACR,QAAQ,EACR,cAAc,EAAE,EAChB,OAAO,CACR,EAAA;;wBANK,GAAG,GAAG,SAMX;wBACD,sBAAO,KAAK,CAAC,IAAI,EAAE,GAAG,EAAE,gBAAgB,EAAE,CAAC,EAAC;;;;KAC7C;IAEK,oDAAa,GAAnB,UACE,IAAkB,EAClB,QAAsB,EACtB,QAAuB,EACvB,OAAgB;;;;;4BAEhB,qBAAM,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,EAAA;;wBAAlC,SAAkC,CAAC;wBACvB,qBAAM,eAAe,CAC/B,IAAI,EACJ,QAAQ,EACR,QAAQ,EACR,cAAc,EAAE,EAChB,OAAO,CACR,EAAA;;wBANK,GAAG,GAAG,SAMX;wBACD,kBAAkB,CAAC,GAAG,CAAC,CAAC;wBACxB,sBAAO,IAAI,OAAO,CAAC,cAAO,CAAC,CAAC,EAAC;;;;KAC9B;IAED,kDAAW,GAAX,UAAY,IAAkB;QAA9B,iBAsBC;QArBC,IAAM,GAAG,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;QACxB,IAAI,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,EAAE;YACrB,IAAA,KAAuB,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,EAA5C,OAAO,aAAA,EAAE,SAAO,aAA4B,CAAC;YACrD,IAAI,OAAO,EAAE;gBACX,OAAO,OAAO,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;aACjC;iBAAM;gBACL,WAAW,CAAC,SAAO,EAAE,0CAA0C,CAAC,CAAC;gBACjE,OAAO,SAAO,CAAC;aAChB;SACF;QAED,IAAM,OAAO,GAAG,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAC7C,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,EAAE,OAAO,SAAA,EAAE,CAAC;QAEtC,oEAAoE;QACpE,kCAAkC;QAClC,OAAO,CAAC,KAAK,CAAC;YACZ,OAAO,KAAI,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC;QACjC,CAAC,CAAC,CAAC;QAEH,OAAO,OAAO,CAAC;IACjB,CAAC;IAEa,wDAAiB,GAA/B,UAAgC,IAAkB;;;;;4BACjC,qBAAM,WAAW,CAAC,IAAI,CAAC,EAAA;;wBAAhC,MAAM,GAAG,SAAuB;wBAChC,OAAO,GAAG,IAAI,gBAAgB,CAAC,IAAI,CAAC,CAAC;wBAC3C,MAAM,CAAC,QAAQ,CACb,WAAW,EACX,UAAC,WAAiC;4BAChC,OAAO,CAAC,WAAW,aAAX,WAAW,uBAAX,WAAW,CAAE,SAAS,EAAE,IAAI,8DAAmC,CAAC;4BACxE,gEAAgE;4BAEhE,IAAM,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,WAAW,CAAC,SAAS,CAAC,CAAC;4BACvD,OAAO,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC,6BAAiB,CAAC,gCAAkB,EAAE,CAAC;wBACnE,CAAC,EACD,IAAI,CAAC,OAAO,CAAC,2BAA2B,CACzC,CAAC;wBAEF,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC,GAAG,EAAE,OAAO,SAAA,EAAE,CAAC;wBAC9C,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC,GAAG,MAAM,CAAC;wBACnC,sBAAO,OAAO,EAAC;;;;KAChB;IAED,mEAA4B,GAA5B,UACE,IAAkB,EAClB,EAAmC;QAEnC,IAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC;QACzC,MAAM,CAAC,IAAI,CACT,uBAAuB,EACvB,EAAE,IAAI,EAAE,uBAAuB,EAAE,EACjC,UAAA,MAAM;;YACJ,IAAM,WAAW,GAAG,MAAA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAG,CAAC,CAAC,0CAAG,uBAAuB,CAAC,CAAC;YAC3D,IAAI,WAAW,KAAK,SAAS,EAAE;gBAC7B,EAAE,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC;aACnB;YAED,KAAK,CAAC,IAAI,sDAA+B,CAAC;QAC5C,CAAC,EACD,IAAI,CAAC,OAAO,CAAC,2BAA2B,CACzC,CAAC;IACJ,CAAC;IAED,wDAAiB,GAAjB,UAAkB,IAAkB;QAClC,IAAM,GAAG,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;QACxB,IAAI,CAAC,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,EAAE;YACvC,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,GAAG,eAAe,CAAC,IAAI,CAAC,CAAC;SAC5D;QAED,OAAO,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,CAAC;IAC5C,CAAC;IAED,sBAAI,gEAAsB;aAA1B;YACE,+DAA+D;YAC/D,OAAO,gBAAgB,EAAE,IAAI,SAAS,EAAE,IAAI,MAAM,EAAE,CAAC;QACvD,CAAC;;;OAAA;IAKH,mCAAC;AAAD,CAAC,AAjID,IAiIC;AAED;;;;;;;;GAQG;AACH,MAAM,CAAC,IAAM,4BAA4B,GACvC,4BAA4B,CAAC\"}","dts":{"name":"/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/node_modules/.cache/rollup-plugin-typescript2/placeholder/src/platform_browser/popup_redirect.d.ts","writeByteOrderMark":false,"text":"/**\r\n * @license\r\n * Copyright 2020 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nimport { PopupRedirectResolver } from '../model/public_types';\r\n/**\r\n * An implementation of {@link PopupRedirectResolver} suitable for browser\r\n * based applications.\r\n *\r\n * @remarks\r\n * This method does not work in a Node.js environment.\r\n *\r\n * @public\r\n */\r\nexport declare const browserPopupRedirectResolver: PopupRedirectResolver;\r\n"}}
