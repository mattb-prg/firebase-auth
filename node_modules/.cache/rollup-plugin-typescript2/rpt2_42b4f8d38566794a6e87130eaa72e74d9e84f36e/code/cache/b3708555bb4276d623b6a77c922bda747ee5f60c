{"code":"/**\r\n * @license\r\n * Copyright 2021 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nimport { __awaiter, __generator } from \"tslib\";\r\nimport { browserSessionPersistence } from '../../platform_browser/persistence/session_storage';\r\nimport { _createError, _fail } from '../../core/util/assert';\r\nimport { _checkCordovaConfiguration, _generateHandlerUrl, _performRedirect, _validateOrigin, _waitForAppResume } from './utils';\r\nimport { CordovaAuthEventManager, _eventFromPartialAndUrl, _generateNewEvent, _getAndRemoveEvent, _savePartialEvent } from './events';\r\nimport { _getRedirectResult } from '../../platform_browser/strategies/redirect';\r\nimport { _clearRedirectOutcomes, _overrideRedirectResult } from '../../core/strategies/redirect';\r\nimport { _cordovaWindow } from '../plugins';\r\n/**\r\n * How long to wait for the initial auth event before concluding no\r\n * redirect pending\r\n */\r\nvar INITIAL_EVENT_TIMEOUT_MS = 500;\r\nvar CordovaPopupRedirectResolver = /** @class */ (function () {\r\n    function CordovaPopupRedirectResolver() {\r\n        this._redirectPersistence = browserSessionPersistence;\r\n        this._shouldInitProactively = true; // This is lightweight for Cordova\r\n        this.eventManagers = new Map();\r\n        this.originValidationPromises = {};\r\n        this._completeRedirectFn = _getRedirectResult;\r\n        this._overrideRedirectResult = _overrideRedirectResult;\r\n    }\r\n    CordovaPopupRedirectResolver.prototype._initialize = function (auth) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var key, manager;\r\n            return __generator(this, function (_a) {\r\n                key = auth._key();\r\n                manager = this.eventManagers.get(key);\r\n                if (!manager) {\r\n                    manager = new CordovaAuthEventManager(auth);\r\n                    this.eventManagers.set(key, manager);\r\n                    this.attachCallbackListeners(auth, manager);\r\n                }\r\n                return [2 /*return*/, manager];\r\n            });\r\n        });\r\n    };\r\n    CordovaPopupRedirectResolver.prototype._openPopup = function (auth) {\r\n        _fail(auth, \"operation-not-supported-in-this-environment\" /* AuthErrorCode.OPERATION_NOT_SUPPORTED */);\r\n    };\r\n    CordovaPopupRedirectResolver.prototype._openRedirect = function (auth, provider, authType, eventId) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var manager, event, url, iabRef;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        _checkCordovaConfiguration(auth);\r\n                        return [4 /*yield*/, this._initialize(auth)];\r\n                    case 1:\r\n                        manager = _a.sent();\r\n                        return [4 /*yield*/, manager.initialized()];\r\n                    case 2:\r\n                        _a.sent();\r\n                        // Reset the persisted redirect states. This does not matter on Web where\r\n                        // the redirect always blows away application state entirely. On Cordova,\r\n                        // the app maintains control flow through the redirect.\r\n                        manager.resetRedirect();\r\n                        _clearRedirectOutcomes();\r\n                        return [4 /*yield*/, this._originValidation(auth)];\r\n                    case 3:\r\n                        _a.sent();\r\n                        event = _generateNewEvent(auth, authType, eventId);\r\n                        return [4 /*yield*/, _savePartialEvent(auth, event)];\r\n                    case 4:\r\n                        _a.sent();\r\n                        return [4 /*yield*/, _generateHandlerUrl(auth, event, provider)];\r\n                    case 5:\r\n                        url = _a.sent();\r\n                        return [4 /*yield*/, _performRedirect(url)];\r\n                    case 6:\r\n                        iabRef = _a.sent();\r\n                        return [2 /*return*/, _waitForAppResume(auth, manager, iabRef)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    CordovaPopupRedirectResolver.prototype._isIframeWebStorageSupported = function (_auth, _cb) {\r\n        throw new Error('Method not implemented.');\r\n    };\r\n    CordovaPopupRedirectResolver.prototype._originValidation = function (auth) {\r\n        var key = auth._key();\r\n        if (!this.originValidationPromises[key]) {\r\n            this.originValidationPromises[key] = _validateOrigin(auth);\r\n        }\r\n        return this.originValidationPromises[key];\r\n    };\r\n    CordovaPopupRedirectResolver.prototype.attachCallbackListeners = function (auth, manager) {\r\n        var _this = this;\r\n        // Get the global plugins\r\n        var _a = _cordovaWindow(), universalLinks = _a.universalLinks, handleOpenURL = _a.handleOpenURL, BuildInfo = _a.BuildInfo;\r\n        var noEventTimeout = setTimeout(function () { return __awaiter(_this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: \r\n                    // We didn't see that initial event. Clear any pending object and\r\n                    // dispatch no event\r\n                    return [4 /*yield*/, _getAndRemoveEvent(auth)];\r\n                    case 1:\r\n                        // We didn't see that initial event. Clear any pending object and\r\n                        // dispatch no event\r\n                        _a.sent();\r\n                        manager.onEvent(generateNoEvent());\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        }); }, INITIAL_EVENT_TIMEOUT_MS);\r\n        var universalLinksCb = function (eventData) { return __awaiter(_this, void 0, void 0, function () {\r\n            var partialEvent, finalEvent;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        // We have an event so we can clear the no event timeout\r\n                        clearTimeout(noEventTimeout);\r\n                        return [4 /*yield*/, _getAndRemoveEvent(auth)];\r\n                    case 1:\r\n                        partialEvent = _a.sent();\r\n                        finalEvent = null;\r\n                        if (partialEvent && (eventData === null || eventData === void 0 ? void 0 : eventData['url'])) {\r\n                            finalEvent = _eventFromPartialAndUrl(partialEvent, eventData['url']);\r\n                        }\r\n                        // If finalEvent is never filled, trigger with no event\r\n                        manager.onEvent(finalEvent || generateNoEvent());\r\n                        return [2 /*return*/];\r\n                }\r\n            });\r\n        }); };\r\n        // Universal links subscriber doesn't exist for iOS, so we need to check\r\n        if (typeof universalLinks !== 'undefined' &&\r\n            typeof universalLinks.subscribe === 'function') {\r\n            universalLinks.subscribe(null, universalLinksCb);\r\n        }\r\n        // iOS 7 or 8 custom URL schemes.\r\n        // This is also the current default behavior for iOS 9+.\r\n        // For this to work, cordova-plugin-customurlscheme needs to be installed.\r\n        // https://github.com/EddyVerbruggen/Custom-URL-scheme\r\n        // Do not overwrite the existing developer's URL handler.\r\n        var existingHandleOpenURL = handleOpenURL;\r\n        var packagePrefix = \"\".concat(BuildInfo.packageName.toLowerCase(), \"://\");\r\n        _cordovaWindow().handleOpenURL = function (url) { return __awaiter(_this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                if (url.toLowerCase().startsWith(packagePrefix)) {\r\n                    // We want this intentionally to float\r\n                    // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n                    universalLinksCb({ url: url });\r\n                }\r\n                // Call the developer's handler if it is present.\r\n                if (typeof existingHandleOpenURL === 'function') {\r\n                    try {\r\n                        existingHandleOpenURL(url);\r\n                    }\r\n                    catch (e) {\r\n                        // This is a developer error. Don't stop the flow of the SDK.\r\n                        console.error(e);\r\n                    }\r\n                }\r\n                return [2 /*return*/];\r\n            });\r\n        }); };\r\n    };\r\n    return CordovaPopupRedirectResolver;\r\n}());\r\n/**\r\n * An implementation of {@link PopupRedirectResolver} suitable for Cordova\r\n * based applications.\r\n *\r\n * @public\r\n */\r\nexport var cordovaPopupRedirectResolver = CordovaPopupRedirectResolver;\r\nfunction generateNoEvent() {\r\n    return {\r\n        type: \"unknown\" /* AuthEventType.UNKNOWN */,\r\n        eventId: null,\r\n        sessionId: null,\r\n        urlResponse: null,\r\n        postBody: null,\r\n        tenantId: null,\r\n        error: _createError(\"no-auth-event\" /* AuthErrorCode.NO_AUTH_EVENT */)\r\n    };\r\n}\r\n//# sourceMappingURL=popup_redirect.js.map","references":["/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/model/public_types.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_browser/persistence/session_storage.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/model/auth.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/model/popup_redirect.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_browser/util/popup.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/util/assert.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/errors.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_cordova/popup_redirect/utils.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_cordova/popup_redirect/events.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/auth/auth_event_manager.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_browser/strategies/redirect.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/core/strategies/redirect.ts","/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/src/platform_cordova/plugins.ts"],"map":"{\"version\":3,\"file\":\"popup_redirect.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../../src/platform_cordova/popup_redirect/popup_redirect.ts\"],\"names\":[],\"mappings\":\"AAAA;;;;;;;;;;;;;;;GAeG;;AAGH,OAAO,EAAE,yBAAyB,EAAE,MAAM,oDAAoD,CAAC;AAQ/F,OAAO,EAAE,YAAY,EAAE,KAAK,EAAE,MAAM,wBAAwB,CAAC;AAE7D,OAAO,EACL,0BAA0B,EAC1B,mBAAmB,EACnB,gBAAgB,EAChB,eAAe,EACf,iBAAiB,EAClB,MAAM,SAAS,CAAC;AACjB,OAAO,EACL,uBAAuB,EACvB,uBAAuB,EACvB,iBAAiB,EACjB,kBAAkB,EAClB,iBAAiB,EAClB,MAAM,UAAU,CAAC;AAElB,OAAO,EAAE,kBAAkB,EAAE,MAAM,4CAA4C,CAAC;AAChF,OAAO,EACL,sBAAsB,EACtB,uBAAuB,EACxB,MAAM,gCAAgC,CAAC;AACxC,OAAO,EAAE,cAAc,EAAE,MAAM,YAAY,CAAC;AAE5C;;;GAGG;AACH,IAAM,wBAAwB,GAAG,GAAG,CAAC;AAErC;IAAA;QACW,yBAAoB,GAAG,yBAAyB,CAAC;QACjD,2BAAsB,GAAG,IAAI,CAAC,CAAC,kCAAkC;QACzD,kBAAa,GAAG,IAAI,GAAG,EAAmC,CAAC;QAC3D,6BAAwB,GAAkC,EAAE,CAAC;QAE9E,wBAAmB,GAAG,kBAAkB,CAAC;QACzC,4BAAuB,GAAG,uBAAuB,CAAC;IAwHpD,CAAC;IAtHO,kDAAW,GAAjB,UAAkB,IAAkB;;;;gBAC5B,GAAG,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;gBACpB,OAAO,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;gBAC1C,IAAI,CAAC,OAAO,EAAE;oBACZ,OAAO,GAAG,IAAI,uBAAuB,CAAC,IAAI,CAAC,CAAC;oBAC5C,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;oBACrC,IAAI,CAAC,uBAAuB,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;iBAC7C;gBACD,sBAAO,OAAO,EAAC;;;KAChB;IAED,iDAAU,GAAV,UAAW,IAAkB;QAC3B,KAAK,CAAC,IAAI,4FAAwC,CAAC;IACrD,CAAC;IAEK,oDAAa,GAAnB,UACE,IAAkB,EAClB,QAAsB,EACtB,QAAuB,EACvB,OAAgB;;;;;;wBAEhB,0BAA0B,CAAC,IAAI,CAAC,CAAC;wBACjB,qBAAM,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,EAAA;;wBAAtC,OAAO,GAAG,SAA4B;wBAC5C,qBAAM,OAAO,CAAC,WAAW,EAAE,EAAA;;wBAA3B,SAA2B,CAAC;wBAE5B,yEAAyE;wBACzE,yEAAyE;wBACzE,uDAAuD;wBACvD,OAAO,CAAC,aAAa,EAAE,CAAC;wBACxB,sBAAsB,EAAE,CAAC;wBAEzB,qBAAM,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,EAAA;;wBAAlC,SAAkC,CAAC;wBAE7B,KAAK,GAAG,iBAAiB,CAAC,IAAI,EAAE,QAAQ,EAAE,OAAO,CAAC,CAAC;wBACzD,qBAAM,iBAAiB,CAAC,IAAI,EAAE,KAAK,CAAC,EAAA;;wBAApC,SAAoC,CAAC;wBACzB,qBAAM,mBAAmB,CAAC,IAAI,EAAE,KAAK,EAAE,QAAQ,CAAC,EAAA;;wBAAtD,GAAG,GAAG,SAAgD;wBAC7C,qBAAM,gBAAgB,CAAC,GAAG,CAAC,EAAA;;wBAApC,MAAM,GAAG,SAA2B;wBAC1C,sBAAO,iBAAiB,CAAC,IAAI,EAAE,OAAO,EAAE,MAAM,CAAC,EAAC;;;;KACjD;IAED,mEAA4B,GAA5B,UACE,KAAmB,EACnB,GAAkC;QAElC,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;IAC7C,CAAC;IAED,wDAAiB,GAAjB,UAAkB,IAAkB;QAClC,IAAM,GAAG,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;QACxB,IAAI,CAAC,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,EAAE;YACvC,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,GAAG,eAAe,CAAC,IAAI,CAAC,CAAC;SAC5D;QAED,OAAO,IAAI,CAAC,wBAAwB,CAAC,GAAG,CAAC,CAAC;IAC5C,CAAC;IAEO,8DAAuB,GAA/B,UACE,IAAkB,EAClB,OAAyB;QAF3B,iBA6DC;QAzDC,yBAAyB;QACnB,IAAA,KAA+C,cAAc,EAAE,EAA7D,cAAc,oBAAA,EAAE,aAAa,mBAAA,EAAE,SAAS,eAAqB,CAAC;QAEtE,IAAM,cAAc,GAAG,UAAU,CAAC;;;;oBAChC,iEAAiE;oBACjE,oBAAoB;oBACpB,qBAAM,kBAAkB,CAAC,IAAI,CAAC,EAAA;;wBAF9B,iEAAiE;wBACjE,oBAAoB;wBACpB,SAA8B,CAAC;wBAC/B,OAAO,CAAC,OAAO,CAAC,eAAe,EAAE,CAAC,CAAC;;;;aACpC,EAAE,wBAAwB,CAAC,CAAC;QAE7B,IAAM,gBAAgB,GAAG,UACvB,SAAwC;;;;;wBAExC,wDAAwD;wBACxD,YAAY,CAAC,cAAc,CAAC,CAAC;wBAER,qBAAM,kBAAkB,CAAC,IAAI,CAAC,EAAA;;wBAA7C,YAAY,GAAG,SAA8B;wBAC/C,UAAU,GAAqB,IAAI,CAAC;wBACxC,IAAI,YAAY,KAAI,SAAS,aAAT,SAAS,uBAAT,SAAS,CAAG,KAAK,CAAC,CAAA,EAAE;4BACtC,UAAU,GAAG,uBAAuB,CAAC,YAAY,EAAE,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC;yBACtE;wBAED,uDAAuD;wBACvD,OAAO,CAAC,OAAO,CAAC,UAAU,IAAI,eAAe,EAAE,CAAC,CAAC;;;;aAClD,CAAC;QAEF,wEAAwE;QACxE,IACE,OAAO,cAAc,KAAK,WAAW;YACrC,OAAO,cAAc,CAAC,SAAS,KAAK,UAAU,EAC9C;YACA,cAAc,CAAC,SAAS,CAAC,IAAI,EAAE,gBAAgB,CAAC,CAAC;SAClD;QAED,iCAAiC;QACjC,wDAAwD;QACxD,0EAA0E;QAC1E,sDAAsD;QACtD,yDAAyD;QACzD,IAAM,qBAAqB,GAAG,aAAa,CAAC;QAC5C,IAAM,aAAa,GAAG,UAAG,SAAS,CAAC,WAAW,CAAC,WAAW,EAAE,QAAK,CAAC;QAClE,cAAc,EAAE,CAAC,aAAa,GAAG,UAAM,GAAG;;gBACxC,IAAI,GAAG,CAAC,WAAW,EAAE,CAAC,UAAU,CAAC,aAAa,CAAC,EAAE;oBAC/C,sCAAsC;oBACtC,mEAAmE;oBACnE,gBAAgB,CAAC,EAAE,GAAG,KAAA,EAAE,CAAC,CAAC;iBAC3B;gBACD,iDAAiD;gBACjD,IAAI,OAAO,qBAAqB,KAAK,UAAU,EAAE;oBAC/C,IAAI;wBACF,qBAAqB,CAAC,GAAG,CAAC,CAAC;qBAC5B;oBAAC,OAAO,CAAC,EAAE;wBACV,6DAA6D;wBAC7D,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;qBAClB;iBACF;;;aACF,CAAC;IACJ,CAAC;IACH,mCAAC;AAAD,CAAC,AA/HD,IA+HC;AAED;;;;;GAKG;AACH,MAAM,CAAC,IAAM,4BAA4B,GACvC,4BAA4B,CAAC;AAE/B,SAAS,eAAe;IACtB,OAAO;QACL,IAAI,uCAAuB;QAC3B,OAAO,EAAE,IAAI;QACb,SAAS,EAAE,IAAI;QACf,WAAW,EAAE,IAAI;QACjB,QAAQ,EAAE,IAAI;QACd,QAAQ,EAAE,IAAI;QACd,KAAK,EAAE,YAAY,mDAA6B;KACjD,CAAC;AACJ,CAAC\"}","dts":{"name":"/home/matt/Desktop/Projects/Freelance/Damon Chen/firebase-package/packages/auth/node_modules/.cache/rollup-plugin-typescript2/placeholder/src/platform_cordova/popup_redirect/popup_redirect.d.ts","writeByteOrderMark":false,"text":"/**\r\n * @license\r\n * Copyright 2021 Google LLC\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *   http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\nimport { PopupRedirectResolver } from '../../model/public_types';\r\n/**\r\n * An implementation of {@link PopupRedirectResolver} suitable for Cordova\r\n * based applications.\r\n *\r\n * @public\r\n */\r\nexport declare const cordovaPopupRedirectResolver: PopupRedirectResolver;\r\n"}}
